// This file generated by staff_codegen
// For more information please visit: http://code.google.com/p/staff/
// Client skeleton

#include <memory>
#include <axutil_thread.h>
#include <axis2_util.h>
#include <staff/utils/Log.h>
#include <staff/utils/CrashHandler.h>
#include <staff/common/DataObject.h>
#include <staff/common/Exception.h>
#include <staff/client/ServiceFactory.h>
#include "Echo.h"

void* Run(axutil_thread_t*, void*)
{
  try
  {
    for (int i = 0; i < 30; ++i)
    {
      std::auto_ptr< Echo > pEcho(::staff::ServiceFactory::Inst().GetService< Echo >());
      STAFF_ASSERT(pEcho.get(), "Cannot get client for service echo!");
    }
  }
  STAFF_CATCH_ALL

  return NULL;
}


int main(int /*nArgs*/, const char* /*paszArgs*/[])
{
  static const int nThreadCount = 30;
  axutil_thread_t* pThread[nThreadCount];

  staff::CrashHandler::Enable();

  axutil_env_t *env = NULL;
  env = axutil_env_create_all("echo_blocking_test.log", AXIS2_LOG_LEVEL_TRACE);


  for (int nTh = 0; nTh < nThreadCount; ++nTh)
  {
    pThread[nTh] = axutil_thread_create(env->allocator, NULL, &Run, NULL);
    if (!pThread[nTh])
    {
      fprintf(stderr, "failed to create axutil thread");
      return 1;
    }
  }

  for (int nTh = 0; nTh < nThreadCount; ++nTh)
  {
    axutil_thread_join(pThread[nTh]);
  }

  staff::LogInfo() << "Done";
  AXIS2_SLEEP(1);

  return 0;
}

