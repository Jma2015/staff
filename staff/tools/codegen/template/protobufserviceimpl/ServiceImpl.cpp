// This file generated by staff_codegen
// For more information please visit: http://code.google.com/p/staff/
// DO NOT EDIT

#include <rise/threading/Event.h>
#include <rise/common/ExceptionTemplate.h>
#include "ProtobufConnector.h"
#foreach $(Interface.Includes)
#include "$(Include.Name)Impl.h"
#end
#include "$(Interface.Name).pb.h"
#include "$(Interface.Name)Impl.h"

#ifneq($(Interface.Classes.$Count),0)
$(Project.OpeningNs)\
  enum { ProtobufRequestTimeout = \
#ifneq($($protobufRequestTimeout),)
$($protobufRequestTimeout)\
#else
60000\
#ifeqend
 }; // protobuf request timeout
$(Project.EndingNs)
#ifeqend

#indent +
#cginclude <protobufserviceimpl/Serialization.cpp>
#indent -

#foreach $(Interface.Classes)
$(Class.OpeningNs)
#indent +

$(Class.Name)Impl::$(Class.Name)Impl()
{
}

$(Class.Name)Impl::~$(Class.Name)Impl()
{
}

#foreach $(Class.Members)
$(Member.Return.UsedName) $(Class.Name)Impl::$(Member.Name)($(Member.Params))$(Member.Const)
{
#ifneq($(Member.Return.Type),struct)
#cgerror Return type of $(Class.Name)Impl::$(Member.Name) is not struct
#ifeqend
#ifneq($(Member.Params.$Count),1)
#cgerror Arguments count of $(Class.Name)Impl::$(Member.Name) != 1
#ifeqend
#ifneq($(Member.Params.Param.DataType.Type),struct)
#cgerror Argument type of $(Class.Name)Impl::$(Member.Name) is not struct
#ifeqend
  $(Member.Return.UsedName) tResult;

  // create connector and protobuf service
  $(Project.Namespace)ProtobufConnector tProtobufConnector;
  tProtobufConnector.Create($(Class.NsName.!deprefix/$($rootns)/)::descriptor());

  ::google::protobuf::RpcController* pProtobufController = tProtobufConnector.GetController();
  ::google::protobuf::RpcChannel* pProtobufChannel = tProtobufConnector.GetChannel();

  RISE_ASSERTS(pProtobufController, "Protobuf controller is not initialized");
  RISE_ASSERTS(pProtobufChannel, "Protobuf channel is not initialized");

  $(Class.NsName.!deprefix/$($rootns)/)::Stub tProtobufService(pProtobufChannel);

  // make request
  rise::threading::CEvent tEvent;
  $(Member.Params.Param.DataType.NsName.!deprefix/$($rootns)/) tProtoRequest;
  $(Member.Return.NsName.!deprefix/$($rootns)/) tProtoResponse;

  tProtoRequest << request;

  tProtobufService.$(Member.Name)(pProtobufController, &tProtoRequest, &tProtoResponse,
      google::protobuf::NewCallback(&tEvent, &rise::threading::CEvent::Signal));
  RISE_ASSERTS(tEvent.Wait($(Project.Namespace)ProtobufRequestTimeout), "Timeout while waiting response from protobuf service");

  tResult << tProtoResponse;

  return tResult;  // result
}

#end // foreach Class.Members

#indent -
$(Class.EndingNs)
#end
